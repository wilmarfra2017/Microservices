trigger:
- master

resources:
- repo: self

variables:
  - name: system.debug
    value: false
  - name: dockerHubServiceConnection
    value: 'DockerHubConnection'
  - name: tag
    value: '$(Build.BuildId)'
  - name: gatewayImage
    value: 'mart800749/gateway:$(tag)'
  - name: libreriaImage
    value: 'mart800749/libreria:$(tag)'
  - name: seguridadImage
    value: 'mart800749/seguridad:$(tag)'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: __default
  jobs:
  - job: BuildAndPush
    displayName: 'Build and Push Images to Docker Hub'
    steps:
      - task: Docker@2
        displayName: 'Build and Push Gateway Image'
        inputs:
          command: buildAndPush
          dockerfile: '$(Build.SourcesDirectory)/Servicios.api.Gateway/Dockerfile'
          repository: 'mart800749/gateway'
          tags: |
            $(tag)
          containerRegistry: $(dockerHubServiceConnection)
          addPipelineData: false
      - task: Docker@2
        displayName: 'Build and Push Libreria Image'
        inputs:
          command: buildAndPush
          dockerfile: '$(Build.SourcesDirectory)/Servicios.api.Libreria/Dockerfile'
          repository: 'mart800749/libreria'
          tags: |
            $(tag)
          containerRegistry: $(dockerHubServiceConnection)
          addPipelineData: false
      - task: Docker@2
        displayName: 'Build and Push Seguridad Image'
        inputs:
          command: buildAndPush
          dockerfile: '$(Build.SourcesDirectory)/Servicios.api.Seguridad/Dockerfile'
          repository: 'mart800749/seguridad'
          tags: |
            $(tag)
          containerRegistry: $(dockerHubServiceConnection)
          addPipelineData: false

  - job: UpdateK8sDeploymentFiles
    displayName: 'Update Kubernetes deployment files with new image tags'
    steps:
    - checkout: self
    - task: Bash@3
      displayName: 'Update Image Tags in K8s Deployment Files'
      inputs:
        targetType: 'inline'
        script: |
          sed -i "s|image: .*\/gateway:.*|image: $(gatewayImage)|g" $(Build.SourcesDirectory)/gateway-deploy.yml
          sed -i "s|image: .*\/libreria:.*|image: $(libreriaImage)|g" $(Build.SourcesDirectory)/microservice-libreria-deploy.yml
          sed -i "s|image: .*\/seguridad:.*|image: $(seguridadImage)|g" $(Build.SourcesDirectory)/microservice-seguridad-deploy.yml
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Updated Kubernetes Deployment Files'
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)'
        ArtifactName: 'k8s'
        publishLocation: 'Container'

  - job: DeployToKubernetes
    displayName: 'Deploy to Kubernetes'
    dependsOn: UpdateK8sDeploymentFiles
    condition: succeeded()
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: DownloadPipelineArtifact@2
      inputs:
        artifactName: 'k8s'
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - task: Kubernetes@1
      displayName: 'Deploy Gateway'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionEndpoint: 'AKS-Service-Connection'
        azureResourceGroup: 'microservice-resourcegroup'
        kubernetesCluster: 'microservices-cluster'
        command: apply
        arguments: '-f $(System.DefaultWorkingDirectory)/k8s/gateway-deploy.yml --namespace production'

    - task: Kubernetes@1
      displayName: 'Deploy Libreria'
      inputs:
        command: apply
        arguments: '-f $(System.DefaultWorkingDirectory)/k8s/microservice-libreria-deploy.yml --namespace production'

    - task: Kubernetes@1
      displayName: 'Deploy Seguridad'
      inputs:
        command: apply
        arguments: '-f $(System.DefaultWorkingDirectory)/k8s/microservice-seguridad-deploy.yml --namespace production'

    - task: Kubernetes@1
      displayName: 'Deploy MongoDB'
      inputs:
        command: apply
        arguments: '-f $(System.DefaultWorkingDirectory)/k8s/mongo-deploy.yml --namespace production'

    - task: Kubernetes@1
      displayName: 'Deploy SQL Server'
      inputs:
        command: apply
        arguments: '-f $(System.DefaultWorkingDirectory)/k8s/sqlserver-deploy.yml --namespace production'
